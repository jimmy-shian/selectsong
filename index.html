<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歌曲選擇系統</title>
    <link rel="icon" type="image/png" href="img/webicon.svg">
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui@1.13.2/dist/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui-touch-punch@0.2.3/jquery.ui.touch-punch.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #333;
            --border-color: #ddd;
            --panel-bg: #fff;
            --btn-bg: #f0f0f0;
            --btn-hover: #e0e0e0;
            --accent-color: #4a6da7;
            --delete-color: #dc3545;
            --add-color: #28a745;
            --font-size-base: 16px;
            --font-size-large: 18px;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .dark-mode {
            --bg-color: #222;
            --text-color: #eee;
            --border-color: #444;
            --panel-bg: #333;
            --btn-bg: #444;
            --btn-hover: #555;
            --accent-color: #6c8fc9;
            --delete-color: #e74c3c;
            --add-color: #2ecc71;
            --shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: var(--font-size-base);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
            .header h2{
                    display: block;
            }
        
        .settings-panel {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;

        }

        .theme-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        /* 開關按鈕樣式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .btn-group{
            position: relative;
            display: inline-flex;
        }
        
        .btn-group .btn:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }
        
        .btn-group .btn:last-child {
            padding: 0 8px;
            border-radius: 0 8px 8px 0;
        }
        
        #randomSettingBtn{
            border-radius: 0 8px 8px 0;
        }

        .btn-group .dropdown-content {
            display: none;
            width: 90px;
            height: 1.5rem;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: var(--shadow);
            z-index: 1000;
            min-width: 20px;
            padding: 10px;
        }
        
        .btn-group .dropdown-content.show {
            display: flex;
        }
        
        .btn-group .dropdown-content input {
            width: calc(100% - 25%);
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--accent-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* 圓形滑塊 */
        .slider.round {
            border-radius: 24px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .font-size-btn {
            cursor: pointer;
            padding: 5px 10px;
            background-color: var(--btn-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        #searchSection {
            margin-bottom: 15px;
        }

        #searchInput {
            padding: 10px;
            width: calc(100% - 22px);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: var(--font-size-base);
            background-color: var(--panel-bg);
            color: var(--text-color);
        }

        .btn {
            cursor: pointer;
            padding: 8px 12px;
            background-color: var(--btn-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: var(--font-size-base);
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: var(--btn-hover);
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-add {
            color: var(--add-color);
        }

        .btn-delete {
            color: var(--delete-color);
        }

        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--panel-bg);
            transition: background-color 0.2s;
        }
        
        #songList, #selectedSongs {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        @media (max-width: 768px) {
            #songList {
                max-height: 150px; /* 手機模式下顯示約3首 */
            }
            #selectedSongs {
                max-height: 350px; /* 手機模式下顯示約8首 */
            }
        }

        .song-item:hover {
            background-color: var(--btn-hover);
        }

        .song-item.ui-sortable-helper {
            cursor: move;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .ui-sortable-placeholder {
            border: 1px dashed var(--border-color);
            visibility: visible !important;
            background: var(--btn-bg);
            height: 40px;
        }

        .song-actions {
            display: flex;
            gap: 10px;
        }

        .drag-handle {
            cursor: move;
            padding: 5px;
            color: var(--text-color);
            margin-right: 5px;
        }

        .song-number {
            margin-right: 10px;
            font-weight: bold;
        }

        #adminPanel {
            display: none;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        input[type="text"], input[type="password"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: var(--font-size-base);
            background-color: var(--panel-bg);
            color: var(--text-color);
            margin-right: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            body {
                padding: 10px;
            }

            .song-actions {
                flex-direction: column;
                gap: 5px;
            }

            .btn {
                padding: 10px;
                font-size: var(--font-size-large);
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header h2{
                display: none;
            }
            .settings-panel {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>歌曲選擇系統</h2>
            <div class="settings-panel">
                <div class="theme-toggle">
                    <i class="fas fa-sun" id="lightIcon" style="margin-right: 5px;"></i>
                    <label class="switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider round"></span>
                    </label>
                    <i class="fas fa-moon" id="darkIcon" style="margin-left: 5px;"></i>
                </div>
                <div class="font-size-control">
                    <span>文字大小:</span>
                    <button class="font-size-btn" id="decreaseFontBtn">A-</button>
                    <button class="font-size-btn" id="increaseFontBtn">A+</button>
                </div>

                <div class="btn-group">
                    <button id="randomSelectBtn" class="btn">隨機選擇</button>
                    <button id="randomSettingBtn" class="btn"><i class="fas fa-caret-down"></i></button>
                    <div id="randomDropdown" class="dropdown-content">
                        <input type="number" id="randomCountInput" min="1" placeholder="請輸入數量">
                        <button id="setRandomCountBtn" class="btn">✔</button>
                    </div>
                </div>

                <button id="viewHistoryBtn" class="btn">歷史記錄</button>
            </div>
        </div>

        <div id="historyPanel" class="panel" style="display: none; margin-bottom: 20px;">
            <div class="panel-header">
                <h2>歷史記錄</h2>
                <button id="closeHistoryBtn" class="btn">關閉</button>
            </div>
            <div id="historyList"></div>
        </div>

        <div class="main-content">
            <div class="panel" id="libraryPanel">
                <div class="panel-header">
                    <h2>曲庫資料</h2>
                </div>
                <div id="searchSection">
                    <input type="text" id="searchInput" name="searchingplace" placeholder="輸入歌名或歌號" autocomplete="off">
                </div>
                <div id="songList"></div>
            </div>

            <div class="panel" id="selectedPanel">
                <div class="panel-header">
                    <h2>已選歌曲</h2>
                    <button id="saveCurrentBtn" class="btn" onclick="saveToHistory()">保存當前選擇</button>
                </div>
                <div id="selectedSongs"></div>
            </div>
        </div>

        <button id="openAdminPanel" class="btn">管理歌曲</button>

        <div id="adminPanel">
            <h2>歌曲管理</h2>
            <div id="passwordSection">
                <input type="password" id="adminPassword" placeholder="管理密碼">
                <button id="verifyPasswordBtn" class="btn">驗證密碼</button>
            </div>
            <div id="songManagementSection" style="display: none;">
                <div style="margin-top: 15px;">
                    <input type="text" id="newSongId" placeholder="歌曲編號">
                    <input type="text" id="newSongName" placeholder="歌曲名稱">
                    <button id="addSongBtn" class="btn">新增歌曲</button>
                </div>
                <div style="margin-top: 15px;">
                    <button id="loadFromSheetBtn" class="btn">從Google Sheet載入歌單</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 原始歌曲資料（作為備用）
        const ORIGINAL_SONGS = [
            { id: '410172', name: '天空沒有極限' },
            { id: '42686', name: '夢一場' },
            { id: '40196', name: '戀人未滿' },
            { id: '93054', name: '熱帶雨林' },
            { id: '5769', name: '一千個傷心的理由' },
            { id: '47724', name: '填空' },
            { id: '44603', name: '命運' },
            { id: '42031', name: '猜不透' }
        ];

        let availableSongs = [];
        let selectedSongs = [];
        let randomSongCount = 10; // 預設隨機選擇10首歌曲
        let currentFontSize = 16; // 預設字體大小
        let isDarkMode = false; // 預設淺色模式
        let songHistory = []; // 歷史記錄
        let isAdminLoggedIn = false; // 管理員登入狀態
        const gasApiUrl = 'https://script.google.com/macros/s/AKfycbxMTkroKTitSG-YpK6SUI0llGw_h4O5nRHD4IrK1b-79DBI--UGWh1pGWubPzU0IAvY/exec';
        
        // 載入指示器樣式
        const loadingHtml = '<i class="fas fa-spinner fa-spin"></i> 處理中...';

        // 從song.txt文件加載歌曲數據
        function loadSongsFromFile() {
            fetch('song.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('無法讀取歌曲文件');
                    }
                    return response.text();
                })
                .then(data => {
                    const lines = data.split('\n');
                    const songs = [];
                    
                    lines.forEach(line => {
                        line = line.trim();
                        if (line) {
                            // 處理可能有多個ID的情況（如 "42657, 903242 我愛他"）
                            if (line.includes(',')) {
                                const parts = line.split(',');
                                const id = parts[0].trim();
                                const restParts = parts.slice(1).join(',').trim();
                                const spaceParts = restParts.split(' ');
                                const secondId = spaceParts[0].trim();
                                const name = spaceParts.slice(1).join(' ').trim();
                                
                                if (id && name) {
                                    songs.push({ id: id, name: name });
                                }
                                if (secondId && name) {
                                    songs.push({ id: secondId, name: name });
                                }
                            } else {
                                // 正常情況：ID 歌名
                                const spaceParts = line.split(' ');
                                const id = spaceParts[0].trim();
                                const name = spaceParts.slice(1).join(' ').trim();
                                
                                if (id && name) {
                                    songs.push({ id: id, name: name });
                                }
                            }
                        }
                    });
                    
                    if (songs.length > 0) {
                        availableSongs = songs;
                    } else {
                        // 如果無法從文件加載歌曲，使用原始歌曲數據作為備用
                        availableSongs = [...ORIGINAL_SONGS];
                        console.error('無法從文件加載歌曲，使用備用數據');
                    }
                    
                    // 渲染歌曲列表
                    renderSongList();
                })
                .catch(error => {
                    console.error('加載歌曲文件時出錯:', error);
                    // 使用原始歌曲數據作為備用
                    availableSongs = [...ORIGINAL_SONGS];
                    renderSongList();
                });
        }

        function showFloatingMessage(message) {
            const messageBox = $('<div></div>')
                .text(message)
                .css({
                    position: 'fixed',
                    bottom: '20px',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    background: 'rgba(0, 0, 0, 0.7)',
                    color: '#fff',
                    padding: '10px 20px',
                    borderRadius: '5px',
                    fontSize: '16px',
                    zIndex: 9999,
                    textAlign: 'center'
                })
                .appendTo('body');

            setTimeout(() => {
                messageBox.fadeOut(500, function () {
                    $(this).remove();
                });
            }, 1500);
        }
        
        // 從localStorage讀取設定
        function loadSettings() {
            // 讀取隨機歌曲數量
            const savedCount = localStorage.getItem('randomSongCount');
            if (savedCount) {
                randomSongCount = parseInt(savedCount);
            }
            
            // 讀取已選歌曲
            const savedSongs = localStorage.getItem('selectedSongs');
            if (savedSongs) {
                try {
                    const parsedSongs = JSON.parse(savedSongs);
                    selectedSongs = parsedSongs;
                    renderSelectedSongs();
                } catch (e) {
                    console.error('無法解析已儲存的歌曲', e);
                }
            }

            // 讀取歷史記錄
            const savedHistory = localStorage.getItem('songHistory');
            if (savedHistory) {
                try {
                    songHistory = JSON.parse(savedHistory);
                } catch (e) {
                    console.error('無法解析歷史記錄', e);
                    songHistory = [];
                }
            }

            // 讀取字體大小
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                currentFontSize = parseInt(savedFontSize);
                updateFontSize();
            }

            // 讀取主題模式
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                $('#themeToggle').prop('checked', true);
            }
            
            // 讀取管理員登入狀態
            const savedLoginState = localStorage.getItem('adminLoggedIn');
            const password = $('#adminPassword').val().trim(); // 確保去除空白
            // 只有當 localStorage 為 'true'，且輸入框有值時，才設定 isAdminLoggedIn 為 true
            isAdminLoggedIn = savedLoginState === 'true' && password !== '';
        }
        
        // 儲存設定到localStorage
        function saveSettings() {
            localStorage.setItem('randomSongCount', randomSongCount);
            localStorage.setItem('selectedSongs', JSON.stringify(selectedSongs));
            localStorage.setItem('fontSize', currentFontSize);
            localStorage.setItem('darkMode', isDarkMode);
            localStorage.setItem('songHistory', JSON.stringify(songHistory));
            localStorage.setItem('adminLoggedIn', isAdminLoggedIn);
        }

        // 更新字體大小
        function updateFontSize() {
            document.documentElement.style.setProperty('--font-size-base', `${currentFontSize}px`);
            document.documentElement.style.setProperty('--font-size-large', `${currentFontSize + 2}px`);
        }

        // 渲染歌曲列表
        function renderSongList(filteredSongs = null) {
            const $songList = $('#songList');
            $songList.empty();
            
            const songsToRender = filteredSongs || availableSongs;
            
            if (songsToRender.length === 0) {
                $songList.html('<div class="song-item">沒有符合的歌曲</div>');
                return;
            }
            
            songsToRender.forEach(song => {
                const isSelected = selectedSongs.some(s => s.id === song.id);
                const $songItem = $(`
                    <div class="song-item" data-id="${song.id}">
                        <span>${song.id} - ${song.name}</span>
                        <button class="btn btn-add" onclick="addSong('${song.id}')" ${isSelected ? 'disabled' : ''}>
                            ${isSelected ? '已選' : '+'}
                        </button>
                    </div>
                `);
                $songList.append($songItem);
            });
        }

        function renderSelectedSongs() {
            const $selectedSongs = $('#selectedSongs');
            $selectedSongs.empty();
            
            if (selectedSongs.length === 0) {
                $selectedSongs.html('<div class="song-item">尚未選擇歌曲</div>');
                return;
            }
            
            selectedSongs.forEach((song, index) => {
                const $songItem = $(`
                    <div class="song-item" data-id="${song.id}" data-index="${index}">
                        <div>
                            <span class="drag-handle">☰</span>
                            <span class="song-number">${index + 1}.</span>
                            <span>${song.id} - ${song.name}</span>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-delete" onclick="removeSong('${song.id}')">刪除</button>
                        </div>
                    </div>
                `);
                $selectedSongs.append($songItem);
            });
            
            // 自動滾動到底部
            // $selectedSongs.scrollTop($selectedSongs[0].scrollHeight);
            
            // 啟用拖曳排序
            $selectedSongs.sortable({
                handle: '.drag-handle',
                axis: 'y',
                update: function(event, ui) {
                    const newOrder = [];
                    $(this).find('.song-item').each(function() {
                        const songId = $(this).attr('data-id');
                        const song = selectedSongs.find(s => s.id === songId);
                        if (song) newOrder.push(song);
                    });
                    selectedSongs = newOrder;
                    renderSelectedSongs();
                    saveSettings();
                }
            }).disableSelection();
        }

        function addSong(songId) {
            const song = availableSongs.find(s => s.id === songId);
            if (song && !selectedSongs.some(s => s.id === songId)) {
                selectedSongs.push(song);
                
                
                renderSelectedSongs();
                renderSongList(); // 重新渲染歌曲列表以更新按鈕狀態
                const $selectedSongs = $('#selectedSongs');
                // 自動滾動到底部
                $selectedSongs.scrollTop($selectedSongs[0].scrollHeight);
                saveSettings();
            }
        }
        
        // 保存當前選擇到歷史記錄
        function saveToHistory() {
            if (selectedSongs.length === 0) {
                showFloatingMessage('沒有選擇歌曲，無法保存');
                return;
            }
            
            const $btn = $('#saveCurrentBtn');
            const originalText = $btn.text();
            
            // 禁用按鈕並顯示載入指示器
            $btn.prop('disabled', true).html(loadingHtml);
            
            // 模擬保存過程（實際上是立即的，但為了UI一致性添加短暫延遲）
            setTimeout(function() {
                const timestamp = new Date().toLocaleString();
                const historyItem = {
                    id: Date.now(), // 使用時間戳作為唯一ID
                    timestamp: timestamp,
                    songs: [...selectedSongs]
                };
                
                songHistory.unshift(historyItem); // 添加到歷史記錄的開頭
                saveSettings();
                showFloatingMessage('已保存到歷史記錄');
                
                // 恢復按鈕狀態
                $btn.prop('disabled', false).text(originalText);
            }, 500);
        }

        function removeSong(songId) {
            selectedSongs = selectedSongs.filter(song => song.id !== songId);
            renderSelectedSongs();
            renderSongList(); // 重新渲染歌曲列表以更新按鈕狀態
            saveSettings();
        }

        // 即時搜尋功能（輸入事件）
        $('#searchInput').on('input', function() {
            searchSongs();
        });

        // 當輸入框獲得焦點時，也執行搜尋
        $('#searchInput').on('focus', function() {
            searchSongs();
        });

        // 即時搜尋功能
        // 整合本地與音圓API查詢
        function searchSongs() {
            const searchTerm = $('#searchInput').val().toLowerCase().trim().replace(/\s+/g, '');
            const $songList = $('#songList');
            if (searchTerm.trim() === '') {
                renderSongList();
                return;
            }
            // 1. 本地搜尋
            const filteredSongs = availableSongs.filter(song => 
                song.name.toLowerCase().includes(searchTerm) || 
                song.id.toLowerCase().includes(searchTerm)
            );
            $songList.empty();
            renderSongList(filteredSongs);

            // 2. 音圓API查詢（遠端）
            const keyword = encodeURIComponent($('#searchInput').val().trim());
            if (!keyword) return;
            // 避免重複查詢（如空白）
            $songList.append('<div id="remote-loading" style="padding:10px;color:#888;">正在查詢音圓曲庫...</div>');
            const apiUrl = `https://song.corp.com.tw/api/song.aspx?company=音圓&cusType=searchList&keyword=${encodeURIComponent(keyword)}`;
            fetch(apiUrl)
                .then(res => res.json())
                .then(function(remoteSongs) {
                    $('#remote-loading').remove();
                    $songList.append('<div style="border-top:1px dashed #aaa;margin:10px 0 5px 0;"></div><div style="color:#4a6da7;font-weight:bold;margin-bottom:5px;">音圓曲庫查詢結果</div>');
                    const $remoteList = $('<div id="remote-song-list"></div>');
                    if (!Array.isArray(remoteSongs) || remoteSongs.length === 0) {
                        $remoteList.append('<div style="color:#888;">查無音圓曲庫資料</div>');
                    } else {
                        remoteSongs.forEach(song => {
                            const isSelected = selectedSongs.some(s => s.id === song.code);
                            const $songItem = $(`
                                <div class="song-item remote" data-id="${song.code}">
                                    <span>${song.code} - ${song.name} <span style="color:#888;font-size:12px;">${song.lang ? song.lang + ' / ' : ''}${song.singer}</span></span>
                                    <button class="btn btn-add remote-add" data-id="${song.code}" ${isSelected ? 'disabled' : ''}>${isSelected ? '已選' : '+'}</button>
                                </div>
                            `);
                            $remoteList.append($songItem);
                        });
                    }
                    $songList.append($remoteList);

                    // 綁定遠端加歌按鈕事件
                    $remoteList.find('.remote-add').off('click').on('click', function() {
                        const songId = $(this).data('id');
                        const song = remoteSongs.find(s => s.code === songId);
                        if (song) {
                            // 1. 加入已選清單（如未重複）
                            if (!selectedSongs.some(s => s.id === song.code)) {
                                selectedSongs.push({
                                    id: song.code,
                                    name: song.name,
                                    lang: song.lang,
                                    singer: song.singer
                                });
                                renderSelectedSongs();
                                renderSongList();
                                saveSettings();
                            }
                            // 2. 自動填入管理區輸入框
                            $('#newSongId').val(song.code);
                            $('#newSongName').val(song.name);
                        }
                    });
                })
                .catch(function() {
                    $('#remote-loading').remove();
                    $songList.append('<div style="color:red;">音圓曲庫查詢失敗</div>');
                });
        };

        // 隨機選擇
        $('#randomSelectBtn').click(function() {
            // 使用當前設定的數量直接進行隨機選擇
            const availableForRandom = availableSongs.filter(song => 
                !selectedSongs.some(s => s.id === song.id)
            );
            
            const randomSongs = availableForRandom
                .sort(() => 0.5 - Math.random())
                .slice(0, randomSongCount);
            
            randomSongs.forEach(song => addSong(song.id));
        });

        // 設定按鈕的點擊事件
        $('#randomSettingBtn').click(function(e) {
            e.stopPropagation();
            $('#randomDropdown').toggleClass('show');
            $('#randomCountInput').val(randomSongCount);
        });

        // 確認設定新的隨機數量
        $('#setRandomCountBtn').click(function() {
            const newCount = parseInt($('#randomCountInput').val());
            if (!isNaN(newCount) && newCount > 0) {
                randomSongCount = newCount;
                saveSettings();
                $('#randomDropdown').removeClass('show');
                showFloatingMessage('已更新隨機選擇數量');
            }
        });

        // 點擊其他地方關閉下拉選單
        $(document).click(function(e) {
            if (!$(e.target).closest('.btn-group').length) {
                $('.dropdown-content').removeClass('show');
            }
        });
        
        // 渲染歷史記錄
        function renderHistory() {
            const $historyList = $('#historyList');
            $historyList.empty();
            
            if (songHistory.length === 0) {
                $historyList.html('<div class="song-item">沒有歷史記錄</div>');
                return;
            }
            
            songHistory.forEach((history, index) => {
                const $historyItem = $(`
                    <div class="song-item" data-id="${history.id}">
                        <div>
                            <span class="song-number">${index + 1}.</span>
                            <span>${history.timestamp} (${history.songs.length}首)</span>
                        </div>
                        <div class="song-actions">
                            <button class="btn" onclick="loadHistory(${history.id})">載入</button>
                            <button class="btn btn-delete" onclick="deleteHistory(${history.id})">刪除</button>
                        </div>
                    </div>
                `);
                $historyList.append($historyItem);
            });
        }
        
        // 載入歷史記錄
        function loadHistory(historyId) {
            const history = songHistory.find(h => h.id === historyId);
            if (history) {
                if (confirm('這將替換當前已選歌曲，確定要載入嗎？')) {
                    selectedSongs = [...history.songs];
                    renderSelectedSongs();
                    renderSongList();
                    saveSettings();
                    $('#historyPanel').slideUp(300);
                }
            }
        }
        
        // 刪除歷史記錄
        function deleteHistory(historyId) {
            if (confirm('確定要刪除這條歷史記錄嗎？')) {
                songHistory = songHistory.filter(h => h.id !== historyId);
                renderHistory();
                saveSettings();
            }
        }
        
        // 查看歷史記錄按鈕
        $('#viewHistoryBtn').click(function() {
            renderHistory();
            // 使用slideToggle來進行平滑的顯示/隱藏
            $('#historyPanel').slideToggle(300);
        });
        
        // 關閉歷史記錄面板
        $('#closeHistoryBtn').click(function() {
            $('#historyPanel').slideUp(300);
        });

        // 管理面板
        $('#openAdminPanel').click(function() {
            // 使用slideToggle來進行平滑的顯示/隱藏
            $('#adminPanel').toggle(50, function() {
                // 在面板完全展開後，使用jQuery的animate方法平滑滾動到底部
                $('html, body').animate({
                    scrollTop: $(document).height() - $(window).height()
                }, 200);
                $('#adminPassword').focus();
            });
            
            // 如果已經登入，直接顯示管理區域
            if (isAdminLoggedIn) {
                $('#passwordSection').hide();
                $('#songManagementSection').show();
            } else {
                $('#passwordSection').show();
                $('#songManagementSection').hide();
                $('#adminPassword').val('');
            }
        });
        
        // 驗證密碼
        $('#adminPassword').on('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 防止按 Enter 觸發其他默認行為
                $('#verifyPasswordBtn').click(); // 模擬點擊驗證密碼按鈕
            }
        });
        $('#verifyPasswordBtn').click(function() {
            const password = $('#adminPassword').val();
            const $btn = $(this);
            const originalText = $btn.text();
            
            // 禁用按鈕並顯示載入指示器
            $btn.prop('disabled', true).html(loadingHtml);
            
            // 使用本地測試URL
            const apiUrl = gasApiUrl;
            
            // 確認是否要載入新的歌單
            $.get(apiUrl, {
                    action: "verifyPassword",
                    password: password
                },
                function (data) {
                    if (data.success) {  // 根據你的 API 結果，這裡是 success 屬性
                        $('#passwordSection').hide();
                        $('#songManagementSection').show();
                        // 在面板完全展開後，使用jQuery的animate方法平滑滾動到底部
                        $('html, body').animate({
                            scrollTop: $(document).height() - $(window).height()
                        }, 200);
                        isAdminLoggedIn = true;
                        saveSettings(); // 保存登入狀態
                    } else {
                        alert('登入失敗: ' + data.message );
                    }
                    // 恢復按鈕狀態
                    $btn.prop('disabled', false).text(originalText);
                }
            ).fail(function (xhr, status, error) {
                alert('登入失敗: ' + error);
                console.error('API錯誤:', xhr, status, error);
                // 恢復按鈕狀態
                $btn.prop('disabled', false).text(originalText);
            });
        });

        // 新增歌曲
        $('#addSongBtn').click(function() {
            let songId = $('#newSongId').val().trim();
            let songName = $('#newSongName').val().trim();
            const $btn = $(this);
            const originalText = "新增歌曲";
            
            // 禁用按鈕並顯示載入指示器
            $btn.prop('disabled', true).html(loadingHtml);
            
            // 如果ID或名稱為空，嘗試從另一個輸入框中解析多行文本
            if ((!songId || !songName) && (songId || songName)) {
                const inputText = songId || songName;
                const lines = inputText.split(' ').filter(line => line.trim() !== '');
                
                if (lines.length >= 2) {
                    // 第一行作為ID，第二行作為名稱
                    songId = lines[0].trim();
                    songName = lines[1].trim();
                    
                    // 更新輸入框的值
                    $('#newSongId').val(songId);
                    $('#newSongName').val(songName);
                }
            } else {
                // 如果兩個輸入框都有值，則直接使用
                songId = songId.replace(/\s+/g, '');
                songName = songName.replace(/\s+/g, '');
            }
            
            if (songId && songName) {
                // 檢查是否已存在相同曲號和歌名
                const existingSongWithSameIdAndName = availableSongs.find(song => 
                    song.id === songId && song.name === songName
                );
                
                if (existingSongWithSameIdAndName) {
                    // 恢復按鈕狀態
                    $btn.prop('disabled', false).text(originalText);
                    showFloatingMessage('已存在相同曲號和歌名的歌曲');
                    return;
                }
                
                // 檢查是否存在相同歌名但不同曲號
                const existingSongWithSameName = availableSongs.find(song => 
                    song.name === songName && song.id !== songId
                );
                
                // 檢查是否存在相同曲號但不同歌名
                const existingSongWithSameId = availableSongs.find(song => 
                    song.id === songId && song.name !== songName
                );
                
                let confirmMessage = '';
                
                if (existingSongWithSameName) {
                    confirmMessage = `已存在歌名「${songName}」但曲號不同的歌曲，確定要新增嗎？`;
                } else if (existingSongWithSameId) {
                    // 恢復按鈕狀態
                    $btn.prop('disabled', false).text(originalText);
                    alert(`已存在曲號「${songId}」但歌名不同的歌曲`);
                    return;
                } else {
                    // 全新的歌曲，直接新增
                    addNewSong(songId, songName);
                    setTimeout(function() {
                        getSongs();
                        const $songList = $('#songList');
                        // 自動滾動到底部
                        $songList.scrollTop($songList[0].scrollHeight);
                    }, 1500);  // 延遲 1.5 秒執行 getSongs()
                    return;
                }
                
                // 需要確認的情況
                if (confirm(confirmMessage)) {
                    addNewSong(songId, songName);
                    setTimeout(function() {
                        getSongs();
                        const $songList = $('#songList');
                        // 自動滾動到底部
                        $songList.scrollTop($songList[0].scrollHeight);
                    }, 1500);  // 延遲 1.5 秒執行 getSongs()
                } else {
                    // 用戶取消，恢復按鈕狀態
                    $btn.prop('disabled', false).text(originalText);
                }
            } else {
                // 恢復按鈕狀態
                $btn.prop('disabled', false).text(originalText);
                showFloatingMessage('請輸入歌曲編號和名稱');
            }

        });
        
        // 實際新增歌曲的函數
        function addNewSong(songId, songName) {
            addSongToSheet(songId, songName)
        }

        // 從Google Sheet載入歌單
        $('#loadFromSheetBtn').click(function() {
            const $btn = $(this);
            const originalText = $btn.text();
            
            // 禁用按鈕並顯示載入指示器
            $btn.prop('disabled', true).html(loadingHtml);
            
            getSongs($btn, originalText);
        });
        
        function getSongs($btn, originalText){
            // 本地測試用URL
            const localApiUrl = 'http://localhost:8080/getSongs';
            // Google Apps Script部署後的URL (需要替換為實際部署的URL)
            // const gasApiUrl = 'https://script.google.com/macros/s/AKfycbzvR0oqjhxtcWbCo7KoyvryNNDFrw1BbzWPqatWxEr_jk1VYJf6H3-i-mLb-pVlZ4kA/exec';
            
            // 使用本地測試URL
            const apiUrl = gasApiUrl;
            
            // 確認是否要載入新的歌單
            $.get(apiUrl, {
                    action: "getSongs"
                },
                function (data) {
                    if (Array.isArray(data)) {
                        // 更新歌曲列表
                        availableSongs = data;
                        renderSongList();
                        // 顯示 1.5 秒的懸浮訊息
                        showFloatingMessage(`成功從 API 載入 ${data.length} 首歌曲`);
                    } else {
                        alert('API返回格式錯誤');
                    }
                    
                    // 恢復按鈕狀態
                    if ($btn) {
                        $btn.prop('disabled', false).text(originalText);
                    }
                }
            ).fail(function (xhr, status, error) {
                alert('無法連接到API: ' + error);
                console.error('API錯誤:', xhr, status, error);
                
                // 恢復按鈕狀態
                if ($btn) {
                    $btn.prop('disabled', false).text(originalText);
                }
            });
        }
        // 新增歌曲到Google Sheet
        function addSongToSheet(songId, songName) {
            const $btn = $('#addSongBtn');
            const originalText = "新增歌曲";
            
            // 禁用按鈕並顯示載入指示器
            $btn.prop('disabled', true).html(loadingHtml);
            
            // 本地測試用URL
            const localApiUrl = 'http://localhost:8080/addSong';
            // Google Apps Script部署後的URL (需要替換為實際部署的URL)
            // const gasApiUrl = 'https://script.google.com/macros/s/AKfycbzvR0oqjhxtcWbCo7KoyvryNNDFrw1BbzWPqatWxEr_jk1VYJf6H3-i-mLb-pVlZ4kA/exec';
            
            // 使用本地測試URL
            const apiUrl = gasApiUrl;
            $.post(apiUrl, JSON.stringify({
                        action: "addSong",
                        password: $('#adminPassword').val(),
                        songId: songId,
                        songName: songName
                    }),
                function (data) {
                    console.log('API 回應: ' + JSON.stringify(data, null, 2)); // 格式化輸出
                    if (data.success) {
                        showFloatingMessage(`歌曲 "${songName}" 新增成功`);
                        // 清空輸入框
                        $('#newSongId').val('');
                        $('#newSongName').val('');
                    } else {
                        alert(`!!~ 歌曲新增失敗: ${data.message || '未知錯誤'}`);
                    }
                    // 恢復按鈕狀態
                    $btn.prop('disabled', false).text(originalText);
                }
            ).fail(function (xhr, status, error) {
                alert(`!!~ 無法連接到API: ${error}`);
                // 恢復按鈕狀態
                $btn.prop('disabled', false).text(originalText);
            });

        }
        
        // 字體大小控制
        $('#increaseFontBtn').click(function() {
            if (currentFontSize < 24) {
                currentFontSize += 2;
                updateFontSize();
                saveSettings();
            }
        });
        
        $('#decreaseFontBtn').click(function() {
            if (currentFontSize > 12) {
                currentFontSize -= 2;
                updateFontSize();
                saveSettings();
            }
        });
        
        // 主題切換
        $('#themeToggle').change(function() {
            isDarkMode = $(this).is(':checked');
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            saveSettings();
        });
        
        // 初始化
        loadSettings();
        renderSongList();
        renderSelectedSongs();

        // 頁面加載時初始化
        $(document).ready(function() {
            // 從song.txt加載歌曲數據
            loadSongsFromFile();
        });
        
        // 將函數暴露到全局作用域，以便在HTML中調用
        window.addSong = addSong;
        window.removeSong = removeSong;
        window.loadHistory = loadHistory;
        window.deleteHistory = deleteHistory;
        window.saveToHistory = saveToHistory;
    </script>
</body>
</html>
